<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>popReconstruct Alternative Model Specifications • popMethods</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="popReconstruct Alternative Model Specifications">
<meta property="og:description" content="popMethods">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">popMethods</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/popReconstruct.html">popReconstruct Model</a>
    </li>
    <li>
      <a href="../articles/popReconstruct_options.html">popReconstruct Alternative Model Specifications</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ihmeuw-demographics/popMethods/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="popReconstruct_options_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="popReconstruct_options_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="popReconstruct_options_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>popReconstruct Alternative Model Specifications</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ihmeuw-demographics/popMethods/blob/master/vignettes/popReconstruct_options.Rmd"><code>vignettes/popReconstruct_options.Rmd</code></a></small>
      <div class="hidden name"><code>popReconstruct_options.Rmd</code></div>

    </div>

    
    
<p>The purpose of this vignette is to explain the alternative popReconstruct model specifications implemented in this package and how to run <code><a href="../reference/popReconstruct_fit.html">popReconstruct_fit()</a></code> with these different specifications. These modifications to the original popReconstruct have been developed while implementing the popReconstruct model at scale with varying quality of input data but the modifications have not yet been published.</p>
<div id="original-popreconstruct-model" class="section level1">
<h1 class="hasAnchor">
<a href="#original-popreconstruct-model" class="anchor"></a>Original popReconstruct model</h1>
<p>In <code><a href="../articles/popReconstruct.html">vignette("popReconstruct", package = "popMethods")</a></code> the original popReconstruct model is explained and written out. Please read this first and become familiar with the basics of the <code><a href="https://rdrr.io/pkg/demCore/man/ccmpp.html">demCore::ccmpp</a></code> and <code><a href="../reference/popReconstruct_fit.html">popMethods::popReconstruct_fit</a></code> functions.</p>
</div>
<div id="estimate-mx-and-ax" class="section level1">
<h1 class="hasAnchor">
<a href="#estimate-mx-and-ax" class="anchor"></a>Estimate mx and ax</h1>
<p>The survivorship ratio (nSx) is one of the components estimated in the original popReconstruct model. nSx can be calculated using life tables constructed from basic lifetable parameters. <code><a href="https://rdrr.io/pkg/demCore/man/ccmpp.html">demCore::ccmpp</a></code> has been made flexible enough to accept either just nSx or 2 out of 3 of ‘mx’, ‘ax’, or ‘qx’ inputs. <code><a href="../reference/popReconstruct_fit.html">popMethods::popReconstruct_fit</a></code> also can accept either <code>nSx</code> or, <code>mx</code> and <code>ax</code> inputs. This flexibility makes it easier to calculate deaths and life tables from the posterior distribution.</p>
<p>‘ax’ values have known constraints that must be applied. For the terminal age group, ‘ax’ can be any positive value greater than or equal to 0, which is why it is log transformed. For all non-terminal age groups, ‘ax’ is a value between 0 and the size of the age intervals, which is why it is transformed with the logit function and scaled to be between 0 and the age_interval.</p>
<p><strong>Level 1</strong> (likelihood for census counts): <span class="math display">\[\text{log} \ n^{*}_{l,a,t} \sim \text{Normal}(\text{log} \ n_{l,a,t}, \sigma^2_n)\]</span> <strong>Level 2</strong> (map from ccmpp input parameters to projected population counts): <span class="math display">\[n_{l,a,t} = \text{CCMPP}(srb_t, f_{a,t}, n_{l,a,t_0}, s_{l,a,t}, g_{l,a,t})\]</span> <strong>Level 2.1</strong> (calculate survivorship ratio): <span class="math display">\[s_{l,a,t} = F(mx_{l,a,t}, ax_{l,a,t})\]</span> <strong>Level 3.1</strong> (calculate the estimated ccmpp inputs): <span class="math display">\[\begin{aligned} &amp; \ \ \vdots \\
\text{log} \ mx_{l,a,t} &amp;= \text{log} \ mx^*_{l,a,t} + \delta_{mx_{l,a,t}} \\
\text{logit[0, age_interval]} \ ax_{l,a,t} &amp;= \text{logit[0, age_interval]} \ ax^*_{l,a,t} + \delta_{ax_{l,a,t}} \text{; if } A = \text{not terminal age} \\
\text{log} \ ax_{l,a,t} &amp;= \text{log} \ ax^*_{l,a,t} + \delta_{ax_{l,a,t}} \text{; if } A = \text{terminal age}
\end{aligned}\]</span></p>
<p><strong>Level 3.2</strong> (priors for ccmpp input offset parameters): <span class="math display">\[\begin{aligned} &amp; \ \ \vdots \\
\delta_{mx_{l,a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{mx}) \\
\delta_{ax_{l,a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{ax_{\text{non_terminal}}}) \text{; if } A = \text{not terminal age} \\
\delta_{ax_{l,a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{ax_{\text{terminal}}}) \text{; if } A = \text{terminal age}
\end{aligned}\]</span></p>
<p><strong>Level 4</strong> (informative prior distributions representing measurement error): <span class="math display">\[\begin{aligned} \sigma^2_{\nu} &amp;\sim \text{InverseGamma}(\alpha^*_{\nu}, \beta^*_{\nu}) \\
\nu &amp;\in \{{srb, f, n, mx, ax_{\text{non_terminal}}, ax_{\text{terminal}}, g}\} \end{aligned}\]</span></p>
<p><strong>where</strong>:</p>
<p><span class="math display">\[\begin{aligned} &amp; \ \ \vdots \\
mx &amp;= \text{mortality rate} \\
ax &amp;= \text{average number of years lived within the age interval by those dying in the interval} \end{aligned}\]</span></p>
</div>
<div id="estimate-immigration-and-emigration" class="section level1">
<h1 class="hasAnchor">
<a href="#estimate-immigration-and-emigration" class="anchor"></a>Estimate Immigration and Emigration</h1>
<p>In the original popReconstruct model, net migration proportion is one of the components estimated. <code><a href="https://rdrr.io/pkg/demCore/man/ccmpp.html">demCore::ccmpp</a></code> has been made flexible enough to accept either just net migration or both immigration and emigration as inputs. To mirror this flexibility, <code><a href="../reference/popReconstruct_fit.html">popMethods::popReconstruct_fit</a></code> can accept either set of migration inputs. This allows one to set separate hyperparameters for immigration and emigration inputs when available since immigration is often easier to measure.</p>
<p>Below, the net migration (<code>g</code>) inputs and parameters have been replaced by immigration <code>i</code> and emigration <code>e</code> components.</p>
<p><strong>Level 1</strong> (likelihood for census counts): <span class="math display">\[\text{log} \ n^{*}_{l,a,t} \sim \text{Normal}(\text{log} \ n_{l,a,t}, \sigma^2_n)\]</span> <strong>Level 2</strong> (map from ccmpp input parameters to projected population counts): <span class="math display">\[n_{l,a,t} = \text{CCMPP}(srb_t, f_{a,t}, n_{l,a,t_0}, s_{l,a,t}, g_{l,a,t})\]</span> <strong>Level 2.1</strong> (calculate net migration): <span class="math display">\[g_{l,a,t} = i_{l,a,t} - e_{l,a,t}\]</span> <strong>Level 3.1</strong> (calculate the estimated ccmpp inputs): <span class="math display">\[\begin{aligned} &amp; \ \ \vdots \\
\text{log} \ i_{l,a,t} &amp;= \text{log} \ i^*_{l,a,t} + \delta_{i_{l,a,t}} \\
\text{log} \ e_{l,a,t} &amp;= \text{log} \ e^*_{l,a,t} + \delta_{e_{l,a,t}} \end{aligned}\]</span></p>
<p><strong>Level 3.2</strong> (priors for ccmpp input offset parameters): <span class="math display">\[\begin{aligned} &amp; \ \ \vdots \\
\delta_{i_{l,a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{i}) \\
\delta_{e_{l,a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{e})\end{aligned}\]</span></p>
<p><strong>Level 4</strong> (informative prior distributions representing measurement error): <span class="math display">\[\begin{aligned} \sigma^2_{\nu} &amp;\sim \text{InverseGamma}(\alpha^*_{\nu}, \beta^*_{\nu}) \\
\nu &amp;\in \{{srb, f, n, s, i, e}\} \end{aligned}\]</span></p>
<p><strong>where</strong>:</p>
<p><span class="math display">\[\begin{aligned} &amp; \ \ \vdots \\
i &amp;= \text{immigration proportion} \\
e &amp;= \text{emigration proportion} \end{aligned}\]</span></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># `inputs` and `hyperparameters` must include "immigration" and "emigration"</span>
<span class="co"># rather than "net_migration".</span>
<span class="fu">popMethods</span><span class="fu">::</span><span class="fu"><a href="../reference/popReconstruct_fit.html">popReconstruct_fit</a></span><span class="op">(</span>
  inputs <span class="op">=</span> <span class="va">inputs</span>,
  data <span class="op">=</span> <span class="va">data</span>,
  hyperparameters <span class="op">=</span> <span class="va">hyperparameters</span>,
  settings <span class="op">=</span> <span class="va">settings</span>,
  value_col <span class="op">=</span> <span class="st">"value"</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="aggregate-census-data" class="section level1">
<h1 class="hasAnchor">
<a href="#aggregate-census-data" class="anchor"></a>Aggregate Census Data</h1>
<p><code>ccmpp</code> requires that age and year intervals of all inputs are the same and the resulting population projections will have the same intervals. When fitting the popReconstruct model with one year age groups this leads to population projections in one year age groups every calendar year but census data is often not available in one year age groups.</p>
<p>Here is how the original popReconstruct model writes out the likelihood for census counts. It requires that the projected population (<span class="math inline">\(n_{l,a,t}\)</span>) and the census data (<span class="math inline">\(n^{*}_{l,a,t}\)</span>) are both for the same sex-age-year groupings.</p>
<p><span class="math display">\[\text{log} \ n^{*}_{l,a,t} \sim \text{Normal}(\text{log} \ n_{l,a,t}, \sigma^2_n)\]</span> When data is only available in aggregate age groups or only for both sexes combined one strategy could be to split the data to the more detailed groupings needed for the model.</p>
<p>Another that is implemented in <code><a href="../reference/popReconstruct_fit.html">popMethods::popReconstruct_fit</a></code> is to aggregate the detailed estimates <span class="math inline">\(n_{l,a,t}\)</span> so that they match the aggregate groupings available in the data. The variance (<span class="math inline">\(\sigma^2_n\)</span>) is then weighted by the number of sex-age-year groupings included in the aggregate group. So <span class="math inline">\(\sigma^2_n\)</span> actually represents the variance of one single sex-age-year group. This is needed to give equal weight to a census where only the total population may be available and a census where single year age groups for each sex is available.</p>
<p>Below, this is written out for one example data point where the both sexes combined, under 5 age group in 1980 is available. The variance <span class="math inline">\(\sigma^2_n\)</span> is divided by 10 because 2 sexes and 5 single year age groups are included in the data point. <span class="math display">\[\text{log} \ n^{*}_{\text{both},0-5,1980} \sim \text{Normal}(\text{log} \sum_{l=\text{female}}^{\text{male}} \sum_{a=0}^{4} n_{l,a,1980}, \frac{\sigma^2_n}{10})\]</span></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># `data$population` data.table always includes "age_start" and "age_end"</span>
<span class="co"># columns. When fitting a model equivalent to the original popReconstruct model</span>
<span class="co"># the "age_start" values must include all `settings$ages` values. This model</span>
<span class="co"># feature now allows aggregate age groups meaning not all `settings$ages` values</span>
<span class="co"># need to be included. Or 'both' sexes combined can be included in the "sex" column</span>
<span class="co"># of the data.table.</span>
<span class="fu">popMethods</span><span class="fu">::</span><span class="fu"><a href="../reference/popReconstruct_fit.html">popReconstruct_fit</a></span><span class="op">(</span>
  inputs <span class="op">=</span> <span class="va">inputs</span>,
  data <span class="op">=</span> <span class="va">data</span>,
  hyperparameters <span class="op">=</span> <span class="va">hyperparameters</span>,
  settings <span class="op">=</span> <span class="va">settings</span>,
  value_col <span class="op">=</span> <span class="st">"value"</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="linear-splines" class="section level1">
<h1 class="hasAnchor">
<a href="#linear-splines" class="anchor"></a>Linear Splines</h1>
<p>For each demographic component of the popReconstruct model (sex ratio at birth, asfr, baseline population, survival proportion and migration) there is a matrix of initial estimates by year, sex, and/or age. The original popReconstruct model includes a parameter representing the true value for each element of the matrices which when estimating a model with 1 year age groups and 1 year calendar intervals becomes quiet computationally intensive.</p>
<p>Rather than estimating a single parameter for each element in these matrices we need a way to decompose each matrix into a smaller set of parameters over time and age that can still then expand out into the full matrix to be used in CCMPP to project population estimates for 1 year (or 5 year) of age and calendar year intervals.</p>
<div id="original-model-rewritten" class="section level2">
<h2 class="hasAnchor">
<a href="#original-model-rewritten" class="anchor"></a>Original Model Rewritten</h2>
<p>Before explaining how linear splines might be used to address this it is useful to rewrite the popReconstruct model parameters as deviations from the input estimates rather than actually trying to model the true values.</p>
<p><strong>Level 1</strong> (likelihood for census counts): <span class="math display">\[\text{log} \ n^{*}_{l,a,t} \sim \text{Normal}(\text{log} \ n_{l,a,t}, \sigma^2_n)\]</span></p>
<p><strong>Level 2</strong> (map from ccmpp input parameters to projected population counts): <span class="math display">\[n_{l,a,t} = \text{CCMPP}(srb_t, f_{a,t}, n_{l,a,t_0}, s_{l,a,t}, g_{l,a,t})\]</span></p>
<p><strong>Level 3.1</strong> (calculate the estimated ccmpp inputs): <span class="math display">\[\begin{aligned} \text{log} \ srb_t &amp;= \text{log} \ srb^*_t + \delta_{srb_t} \\
\text{log} \ f_{a,t} &amp;= \text{log} \ f^*_{a,t} + \delta_{f_{a,t}} \\
\text{log} \ n_{l,a,t_0} &amp;= \text{log} \ n^*_{l,a,t_0} + \delta_{n_{l,a,t_0}} \\
\text{logit} \ s_{l,a,t} &amp;= \text{logit} \ s^*_{l,a,t} + \delta_{s_{l,a,t}}  \\
g_{l,a,t} &amp;= g^*_{l,a,t} + \delta_{g_{l,a,t}} \end{aligned}\]</span></p>
<p><strong>Level 3.2</strong> (priors for ccmpp input offset parameters): <span class="math display">\[\begin{aligned} \delta_{srb_t} &amp;\sim \text{Normal}(0, \sigma^2_{srb}) \\
\delta_{f_{a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{f}) \\
\delta_{n_{l,a,t_0}} &amp;\sim \text{Normal}(0, \sigma^2_{n}) \\
\delta_{s_{l,a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{s}) \\
\delta_{g_{l,a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{g}) \end{aligned}\]</span></p>
<p><strong>Level 4</strong> (informative prior distributions representing measurement error): <span class="math display">\[\begin{aligned} \sigma^2_{\nu} &amp;\sim \text{InverseGamma}(\alpha^*_{\nu}, \beta^*_{\nu}) \\
\nu &amp;\in \{{srb, f, n, s, g}\} \end{aligned}\]</span></p>
<p><strong>where</strong>: <span class="math display">\[* = \text{input data}\]</span></p>
<p><span class="math display">\[\begin{aligned} l &amp;= \text{sex} \\  a &amp;= \text{age} \\ y &amp;= \text{year} \end{aligned}\]</span></p>
<p><span class="math display">\[\begin{aligned} srb &amp;= \text{sex-ratio at birth} \\
f &amp;= \text{age-specific fertility rate} \\
n &amp;= \text{population} \\ s &amp;= \text{survivorship ratio} \\
g &amp;= \text{net migration proportion} \end{aligned}\]</span></p>
<p><span class="math display">\[\delta = \text{offset or deviation from the initial estimates}\]</span></p>
</div>
<div id="topals-and-linear-splines-background" class="section level2">
<h2 class="hasAnchor">
<a href="#topals-and-linear-splines-background" class="anchor"></a>TOPALS and linear splines background</h2>
<p>The TOPALS relational method (tool for projecting age patterns using linear splines) (Beer (2012), Schmertmann and Gonzaga (2018)) defines a relationship between a standard age pattern and deviations from the age pattern.</p>
<p>For popReconstruct the initial estimates of the ccmpp inputs (asfr, baseline population, etc.) can act as the standard age and time pattern.</p>
<p>The baseline population is a good starting place to explain this because it only involves age and not time. The estimated baseline population <span class="math inline">\(n_{l,a,t_0}\)</span> is equal to the input baseline population <span class="math inline">\(n^*_{l,a,t_0}\)</span> plus the estimated offset or deviation parameters <span class="math inline">\(\delta_{n_{l,a,t_0}}\)</span>.</p>
<p><span class="math display">\[\text{log} \ n_{l,a,t_0} = \text{log} \ n^*_{l,a,t_0} + \delta_{n_{l,a,t_0}}\]</span></p>
<p>To represent deviations from the age pattern, TOPALS uses a piecewise linear function that includes straight line segments between selected ages (knots). <span class="math inline">\(\mathbf{B}^{n_{t_0}}_a\)</span> is a matrix of fixed B-spline linear basis functions for the baseline population count. This matrix has <span class="math inline">\(a\)</span> rows (number of age groups) and <span class="math inline">\(k_a\)</span> columns (the number of knots for the baseline matrix) while <span class="math inline">\(\delta^{n_{t_0}}_{l,k_a,t_0}\)</span> is a sex-specific parameter matrix with <span class="math inline">\(k_a\)</span> rows and <span class="math inline">\(1\)</span> column representing deviations from the input estimates at specific knots.</p>
<p><span class="math display">\[\text{log} \ n_{l,a,t_0} = \text{log} \ n^*_{l,a,t_0} + \mathbf{B}^{n_{t_0}}_a \delta^{n_{t_0}}_{l,k_a,t_0}\]</span> As explained by Schmertmann and Gonzaga (2018), the <span class="math inline">\(\delta^{n_{t_0}}_{l,k_a,t_0}\)</span> parameters are the values of the piecewise function exactly at each knot. For example if we have knots at 0, 10, …, 70, 80 for the baseline year then there are 9 model parameters for the baseline population rather than 17 for the original model with 5-year age groups.</p>
<p>Schmertmann and Gonzaga (2018) calls <span class="math inline">\(\delta^{n_{t_0}}_{l,k_a,t_0}\)</span> the offset parameters and <span class="math inline">\(\mathbf{B}^{n_{t_0}}_a \delta^{n_{t_0}}_{l,k_a,t_0}\)</span> combined are the linear spline offsets.</p>
<p>The estimated baseline population at age 20 is a function of only one element of <span class="math inline">\(\delta^{n_{t_0}}_{l,k_a,t_0}\)</span> because age 20 is one of the knots.</p>
<p><span class="math display">\[\text{log} \ n_{l,20,1960} = \text{log} \ n^*_{l,20,1960} + \frac{1}{1} \delta^{n_{t_0}}_{l,20,1960}\]</span></p>
<p>For age 25, it is a function of multiple elements of <span class="math inline">\(\delta^{n_{t_0}}_{l,k_a,t_0}\)</span> because it is not one of the knots.</p>
<p><span class="math display">\[\text{log} \ n_{l,25,1960} = \text{log} \ n^*_{l,25,1960} + \frac{1}{2} \delta^{n_{t_0}}_{l,20,1960} + \frac{1}{2} \delta^{n_{t_0}}_{l,30,1960}\]</span> You can see the coefficients by examining the <span class="math inline">\(a\)</span> by <span class="math inline">\(k_a\)</span> matrix <span class="math inline">\(\mathbf{B}^{n_{t_0}}_a\)</span> below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># define the ages included in the inputs</span>
<span class="va">ages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">5</span><span class="op">)</span>

<span class="co"># define the knots of the piecewise linear function</span>
<span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span>

<span class="va">B_n_a</span> <span class="op">&lt;-</span> <span class="fu">splines</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/splines/bs.html">bs</a></span><span class="op">(</span>
  <span class="va">ages</span>,
  knots <span class="op">=</span> <span class="va">knots</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">knots</span><span class="op">)</span><span class="op">]</span>, <span class="co"># last age already included as a boundary knot</span>
  degree <span class="op">=</span> <span class="fl">1</span> <span class="co"># this specifies a linear spline</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">B_n_a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">ages</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">B_n_a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">knots</span>
<span class="va">B_n_a</span>
<span class="co">#&gt;      0  10  20  30  40  50  60  70  80</span>
<span class="co">#&gt; 0  1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0</span>
<span class="co">#&gt; 5  0.5 0.5 0.0 0.0 0.0 0.0 0.0 0.0 0.0</span>
<span class="co">#&gt; 10 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0</span>
<span class="co">#&gt; 15 0.0 0.5 0.5 0.0 0.0 0.0 0.0 0.0 0.0</span>
<span class="co">#&gt; 20 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0</span>
<span class="co">#&gt; 25 0.0 0.0 0.5 0.5 0.0 0.0 0.0 0.0 0.0</span>
<span class="co">#&gt; 30 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0</span>
<span class="co">#&gt; 35 0.0 0.0 0.0 0.5 0.5 0.0 0.0 0.0 0.0</span>
<span class="co">#&gt; 40 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0</span>
<span class="co">#&gt; 45 0.0 0.0 0.0 0.0 0.5 0.5 0.0 0.0 0.0</span>
<span class="co">#&gt; 50 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0</span>
<span class="co">#&gt; 55 0.0 0.0 0.0 0.0 0.0 0.5 0.5 0.0 0.0</span>
<span class="co">#&gt; 60 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0</span>
<span class="co">#&gt; 65 0.0 0.0 0.0 0.0 0.0 0.0 0.5 0.5 0.0</span>
<span class="co">#&gt; 70 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0</span>
<span class="co">#&gt; 75 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.5 0.5</span>
<span class="co">#&gt; 80 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0</span>
<span class="co">#&gt; attr(,"degree")</span>
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; attr(,"knots")</span>
<span class="co">#&gt; [1]  0 10 20 30 40 50 60 70</span>
<span class="co">#&gt; attr(,"Boundary.knots")</span>
<span class="co">#&gt; [1]  0 80</span>
<span class="co">#&gt; attr(,"intercept")</span>
<span class="co">#&gt; [1] FALSE</span>
<span class="co">#&gt; attr(,"class")</span>
<span class="co">#&gt; [1] "bs"     "basis"  "matrix"</span></code></pre></div>
<p>This same idea can be applied to reduce year-specific parameters like for sex-ratio at birth.</p>
<p><span class="math display">\[\text{log} \ srb_{t} = \text{log} \ srb^*_{t} + \delta^{srb}_{k_t}{\mathbf{B}^{srb}_t}^\intercal\]</span></p>
<p>And combined for year and age specific parameters like for asfr, survival and migration.</p>
</div>
<div id="popreconstruct-with-linear-splines" class="section level2">
<h2 class="hasAnchor">
<a href="#popreconstruct-with-linear-splines" class="anchor"></a>popReconstruct with Linear Splines</h2>
<p>Level 3 of popReconstruct can be rewritten with the linear splines included. Each of the year specific and age specific knots can be different for each component (srb, asfr, etc.).</p>
<p><strong>Level 3.1</strong> (calculate the estimated ccmpp inputs): <span class="math display">\[\begin{aligned} \text{log} \ srb_t &amp;= \text{log} \ srb^*_t + \delta^{srb}_{k_t}{\mathbf{B}^{srb}_t}^\intercal \\
\text{log} \ f_{a,t} &amp;= \text{log} \ f^*_{a,t} + \mathbf{B}^f_a \delta^f_{k_a,k_t} {\mathbf{B}^{f}_t}^\intercal \\
\text{log} \ n_{l,a,t_0} &amp;= \text{log} \ n^*_{l,a,t_0} + \mathbf{B}^n_a \delta^{n_{0}}_{l,k_a,t_0} \\
\text{logit} \ s_{l,a,t} &amp;= \text{logit} \ s^*_{l,a,t} + \mathbf{B}^s_a \delta^s_{k_a,k_t} {\mathbf{B}^{s}_t}^\intercal  \\
g_{l,a,t} &amp;= g^*_{l,a,t} + \mathbf{B}^g_a \delta^g_{k_a,k_t} {\mathbf{B}^{g}_t}^\intercal \end{aligned}\]</span></p>
<p><strong>Level 3.2</strong> (priors for ccmpp input offset parameters): <span class="math display">\[\begin{aligned} \delta_{srb_{k_t}} &amp;\sim \text{Normal}(0, \sigma^2_{srb}) \\
\delta_{f_{k_a,k_t}} &amp;\sim \text{Normal}(0, \sigma^2_{f}) \\
\delta_{n_{l,k_a,t_0}} &amp;\sim \text{Normal}(0, \sigma^2_{n}) \\
\delta_{s_{l,k_a,k_t}} &amp;\sim \text{Normal}(0, \sigma^2_{s}) \\
\delta_{g_{l,k_a,k_t}} &amp;\sim \text{Normal}(0, \sigma^2_{g}) \end{aligned}\]</span></p>
<p><strong>where</strong>: <span class="math display">\[\begin{aligned} k_a &amp;= \text{age-specific knots} \\
k_t &amp;= \text{year-specific knots} \\
\delta_{\nu} &amp;= \text{offset parameters} \\
\mathbf{B}^{\nu}_a &amp;= \text{fixed B-spline linear basis functions for age} \\
\mathbf{B}^{\nu}_t &amp;= \text{fixed B-spline linear basis functions for time} \\
\mathbf{B}^{\nu}\delta_{\nu} &amp;= \text{linear spline offsets} \end{aligned}\]</span></p>
<p>This model specification can:</p>
<ul>
<li><p>reduce computation time since there are fewer parameters to be estimated.</p></li>
<li><p>smooth deviations from the initial input estimates.</p></li>
<li><p>reduce back to the original model if a knot is included at every single age and year of the inputs.</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># To use this feature use the optional additional settings variables as</span>
<span class="co"># described in the "Optional popReconstruct Settings" of the documentation for</span>
<span class="co"># `popReconstruct_fit`.</span>

<span class="co"># Here is an example of how to use year and age specific knots for the survival component</span>
<span class="va">optional_settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1950</span>, <span class="fl">2020</span>, <span class="fl">1</span><span class="op">)</span>,
  ages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">95</span>, <span class="fl">1</span><span class="op">)</span>,
  k_years_survival <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1950</span>, <span class="fl">2020</span>, <span class="fl">5</span><span class="op">)</span>,
  k_ages_survival <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">15</span>, <span class="fl">60</span>, <span class="fl">95</span><span class="op">)</span>,
  <span class="va">...</span>
<span class="op">)</span></code></pre></div>
</div>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<p>Beer, Joop de. 2012. “Smoothing and projecting age-specific probabilities of death by TOPALS.” Demographic Research 27: 543–92. <a href="https://doi.org/10.4054/DemRes.2012.27.20">doi:10.4054/DemRes.2012.27.20</a>.</p>
<p>Schmertmann, Carl P., and Marcos R. Gonzaga. 2018. “Bayesian Estimation of Age-Specific Mortality and Life Expectancy for Small Areas With Defective Vital Records.” Demography 55 (4). Springer New York LLC: 1363–88. <a href="https://doi.org/10.1007/s13524-018-0695-2">doi:10.1007/s13524-018-0695-2</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Charlton Callender, Katie Paulson, Spencer Pease, Haidong Wang, Institute for Health Metrics and Evaluation.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
