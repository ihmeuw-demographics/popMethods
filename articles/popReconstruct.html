<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>popReconstruct Model • popMethods</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="popReconstruct Model">
<meta property="og:description" content="popMethods">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">popMethods</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/popReconstruct.html">popReconstruct Model</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ihmeuw-demographics/popMethods/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>popReconstruct Model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ihmeuw-demographics/popMethods/blob/master/vignettes/popReconstruct.Rmd"><code>vignettes/popReconstruct.Rmd</code></a></small>
      <div class="hidden name"><code>popReconstruct.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h1>
<p>The most commonly used method for creating population projections is the cohort component method of population project (CCMPP). CCMPP is explained in the <code>vignette("ccmpp", package = "demCore")</code>.</p>
<p>CCMPP takes as input initial estimates of the baseline population, mortality, fertility, migration and sex-ratio at birth, and outputs projected population estimates. There is no guarantee though that the projected population estimates from CCMPP are consistent with available population data from censuses and population registries.</p>
<p>Wheldon et al (2013) introduced a new model they called “popReconstruct” that embeds CCMPP in a Bayesian hierarchical model. popReconstruct reconciles the CCMPP input preliminary estimates of fertility, mortality, migration, and a baseline population with subsequent population data while accounting for measurement error in these initial estimates.</p>
<p>The code for this model has previously been included in the <a href="https://cran.r-project.org/web/packages/popReconstruct/">popReconstruct R package</a>, and includes a detailed vignette that walks through the example in the paper to estimate the Burkina Faso female population between 1960 and 2005. The authors should be commended for publishing an R package with their work, which makes it much easier to expand off of and use.</p>
<p>There are some limitations though of the currently available <a href="https://cran.r-project.org/web/packages/popReconstruct/">popReconstruct R package</a>:</p>
<ol style="list-style-type: decimal">
<li><p>The Metropolis Hastings MCMC sampler is coded in R which is much slower than other languages or software. According to the package vignette, the Burkina Faso example took over 24 hours to run to completion.</p></li>
<li><p>The Metropolis Hastings algorithm requires proposal variances to sample from the posterior distribtion. This is an added input requirement for the analyst.</p></li>
<li><p>The popReconstruct package only implements the female only version of popReconstruct. There is separate <a href="https://github.com/markalava/Bayesian-Reconstruction">code</a> publicly available for estimating both the male and female population but it is not part of the package.</p></li>
<li><p>There are not robust built in validations in the package.</p></li>
</ol>
<p>In order to address these issues and make it easier to expand off the original popReconstruct model, we have included new implementations of the popReconstruct model in the <code>popMethods</code> package.</p>
<p>The <code>popMethods</code> and <code>demCore</code> packages combined currently include:</p>
<ol style="list-style-type: decimal">
<li><p>Both the Burkina Faso and Thailand example data used by Wheldon et al (2013) and Wheldon et al (2015). It is very helpful they released the data originally, we have simply reformated it to work smoothly with the <code>popMethods</code> and <code>demCore</code> functions.</p></li>
<li><p>Flexible population projection functions like <code><a href="https://rdrr.io/pkg/demCore/man/ccmpp.html">demCore::ccmpp</a></code> and <code><a href="https://rdrr.io/pkg/demCore/man/leslie_matrix.html">demCore::leslie_matrix</a></code> that can be used for projecting just the female population or both male and female populations. <code><a href="https://rdrr.io/pkg/demCore/man/ccmpp.html">demCore::ccmpp</a></code> also includes flexibility to use either just net migration or both immigration and emigration inputs.</p></li>
<li><p>The popReconstruct model implemented in both Stan and TMB. These are robust, effecient, and well documented statistical modeling languages that are much faster than the original sampler. In the case of Stan, it also provides access to automatic diagnostics and a large userbase.</p></li>
</ol>
<p>This vignette walks through using the <code>popMethods</code> popReconstruct functions with the Burkina Faso example data.</p>
</div>
<div id="popreconstruct-model" class="section level1">
<h1 class="hasAnchor">
<a href="#popreconstruct-model" class="anchor"></a>popReconstruct model</h1>
<div id="original-popreconstruct-model" class="section level2">
<h2 class="hasAnchor">
<a href="#original-popreconstruct-model" class="anchor"></a>Original popReconstruct model</h2>
<p>The popReconstruct model is a Bayesian hierarchical model that estimates the ccmpp input components (baseline population, srb, asfr, survivorship ratios and net migration) given initial estimates of these components and subsequent population data.</p>
<p>The original model specification described by Wheldon et al (2013) and Wheldon et al (2015) was written similar to below where all the components with a <span class="math inline">\(*\)</span> are inputs to the model. At level 1, census counts are modeled conditional on the projected populations from level 2. The CCMPP input parameters are modeled at level 3 and level 4 specifies an informative prior for the variance parameters for each ccmpp component.</p>
<p><strong>Level 1</strong> (likelihood for census counts): <span class="math display">\[\text{log} \ n^{*}_{l,a,t} \sim \text{Normal}(\text{log} \ n_{l,a,t}, \sigma^2_n)\]</span></p>
<p><strong>Level 2</strong> (map from ccmpp input parameters to projected population counts): <span class="math display">\[n_{l,a,t} = \text{CCMPP}(srb_t, f_{a,t}, n_{l,a,t_0}, s_{l,a,t}, g_{l,a,t})\]</span> <strong>Level 3</strong> (priors for all ccmpp input parameters): <span class="math display">\[\begin{aligned} \text{log} \ srb_t &amp;\sim \text{Normal}(\text{log} \ srb^*_t, \sigma^2_{srb}) \\ \text{log} \ f_{a,t} &amp;\sim \text{Normal}(\text{log} \ f^*_{a,t}, \sigma^2_{f}) \\ \text{log} \ n_{l,a,t_0} &amp;\sim \text{Normal}(\text{log} \ n^*_{l,a,t_0}, \sigma^2_{n}) \\ \text{logit} \ s_{l,a,t} &amp;\sim \text{Normal}(\text{logit} \ s^*_{l,a,t}, \sigma^2_{s}) \\ g_{l,a,t} &amp;\sim \text{Normal}(g^*_{l,a,t}, \sigma^2_{g}) \end{aligned}\]</span></p>
<p><strong>Level 4</strong> (informative prior distributions representing measurement error): <span class="math display">\[\begin{aligned} \sigma^2_{\nu} &amp;\sim \text{InverseGamma}(\alpha^*_{\nu}, \beta^*_{\nu}) \\ \nu &amp;\in \{{srb, f, n, s, g}\} \end{aligned}\]</span></p>
<p><strong>where</strong>: <span class="math display">\[* = \text{input data}\]</span></p>
<p><span class="math display">\[\begin{aligned} l &amp;= \text{sex} \\  a &amp;= \text{age} \\ y &amp;= \text{year}\end{aligned}\]</span></p>
<p><span class="math display">\[\begin{aligned} srb &amp;= \text{sex-ratio at birth} \\ f &amp;= \text{age-specific fertility rate} \\ n &amp;= \text{population} \\ s &amp;= \text{survivorship ratio} \\ g &amp;= \text{net migration proportion} \end{aligned}\]</span></p>
</div>
<div id="original-popreconstruct-model-with-level-3-rewritten" class="section level2">
<h2 class="hasAnchor">
<a href="#original-popreconstruct-model-with-level-3-rewritten" class="anchor"></a>Original popReconstruct model with level 3 rewritten</h2>
<p>The popReconstruct model that is included in the <code>popMethods</code> package is slightly rewritten but equivalent. This needs to be explained because it impacts how the outputs are named and formatted.</p>
<p>Instead of directly modeling the ccmpp inputs at level 3 we model the offset or deviation from the initial estimates. This allows us to use things like linear splines to reduce the number of parameters in the model which is explained more in the <code>vignette("popReconstruct_linear_splines", package = "popMethods)</code>.</p>
<p><strong>Level 3.1</strong> (calculate the estimated ccmpp inputs): <span class="math display">\[\begin{aligned} \text{log} \ srb_t &amp;= \text{log} \ srb^*_t + \delta_{srb_t} \\ \text{log} \ f_{a,t} &amp;= \text{log} \ f^*_{a,t} + \delta_{f_{a,t}} \\ \text{log} \ n_{l,a,t_0} &amp;= \text{log} \ n^*_{l,a,t_0} + \delta_{n_{l,a,t_0}} \\ \text{logit} \ s_{l,a,t} &amp;= \text{logit} \ s^*_{l,a,t} + \delta_{s_{l,a,t}}  \\ g_{l,a,t} &amp;= g^*_{l,a,t} + \delta_{g_{l,a,t}} \end{aligned}\]</span></p>
<p><strong>Level 3.2</strong> (priors for ccmpp input offset parameters): <span class="math display">\[\begin{aligned} \delta_{srb_t} &amp;\sim \text{Normal}(0, \sigma^2_{srb}) \\ \delta_{f_{a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{f}) \\  \delta_{n_{l,a,t_0}} &amp;\sim \text{Normal}(0, \sigma^2_{n}) \\ \delta_{s_{l,a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{s}) \\ \delta_{g_{l,a,t}} &amp;\sim \text{Normal}(0, \sigma^2_{g}) \end{aligned}\]</span></p>
<p><strong>where</strong>: <span class="math display">\[\begin{aligned} \delta_{\nu} &amp;= \text{offset or deviation from the initial estimates} \\ \nu &amp;\in \{{srb, f, n, s, g}\} \end{aligned}\]</span></p>
</div>
</div>
<div id="how-to-use-the-popmethods-popreconstruct-functions" class="section level1">
<h1 class="hasAnchor">
<a href="#how-to-use-the-popmethods-popreconstruct-functions" class="anchor"></a>How to use the popMethods popReconstruct functions</h1>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">popMethods</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">data.table</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">bayesplot</span>)

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">3</span>)</pre></body></html></div>
<p>In order to fit the popReconstruct model using <code><a href="../reference/popReconstruct_fit.html">popMethods::popReconstruct_fit</a></code> we need a list of the settings for the inputs and ccmpp projections. The required settings are the same as <code><a href="https://rdrr.io/pkg/demCore/man/ccmpp.html">demCore::ccmpp</a></code> but there are additional optional settings for <code><a href="../reference/popReconstruct_fit.html">popMethods::popReconstruct_fit</a></code>. The only optional setting we will specify for this example is the number of draws (<code>n_draws</code>) to sample from the prior distribution and the posterior distribution when we fit the model with TMB.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># specify settings for this example</span>
<span class="no">settings</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="co"># settings required for `demCore::ccmpp` or `popMethods::popReconstruct_fit`</span>
  <span class="kw">years</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1960</span>, <span class="fl">2000</span>, <span class="fl">5</span>),
  <span class="kw">sexes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"female"</span>),
  <span class="kw">ages</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">5</span>),
  <span class="kw">ages_survival</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">85</span>, <span class="fl">5</span>),
  <span class="kw">ages_asfr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">15</span>, <span class="fl">45</span>, <span class="fl">5</span>),

  <span class="co"># optional settings for `popMethods::popReconstruct_fit`</span>
  <span class="kw">n_draws</span> <span class="kw">=</span> <span class="fl">200</span>
)</pre></body></html></div>
<p>As mentioned above the popReconstruct model incorporates prior knowledge on the measurement error of ccmpp inputs and population data. These hyperparameters can be backcalculated using <code><a href="../reference/popReconstruct_hyperparameters.html">popMethods::popReconstruct_hyperparameters</a></code> or manually specified as done here to replicate the original popReconstruct paper (Wheldon et al (2013)).</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">hyperparameters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">asfr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">beta</span> <span class="kw">=</span> <span class="fl">0.0109</span>),
                        <span class="kw">population</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">beta</span> <span class="kw">=</span> <span class="fl">0.0109</span>),
                        <span class="kw">survival</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">beta</span> <span class="kw">=</span> <span class="fl">0.0109</span>),
                        <span class="kw">net_migration</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">beta</span> <span class="kw">=</span> <span class="fl">0.0436</span>))</pre></body></html></div>
</div>
<div id="sample-from-the-prior-distribution-for-the-popreconstruct-model" class="section level2">
<h2 class="hasAnchor">
<a href="#sample-from-the-prior-distribution-for-the-popreconstruct-model" class="anchor"></a>Sample from the prior distribution for the popReconstruct model</h2>
<p>Now we can sample from the prior distribution using <code><a href="../reference/popReconstruct_fit.html">popMethods::popReconstruct_prior_draws</a></code>.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">draws_prior</span> <span class="kw">&lt;-</span> <span class="kw pkg">popMethods</span><span class="kw ns">::</span><span class="fu"><a href="../reference/popReconstruct_fit.html">popReconstruct_prior_draws</a></span>(
  <span class="kw">inputs</span> <span class="kw">=</span> <span class="kw pkg">demCore</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/demCore/man/burkina_faso.html">burkina_faso_initial_estimates</a></span>,
  <span class="kw">hyperparameters</span> <span class="kw">=</span> <span class="no">hyperparameters</span>,
  <span class="kw">settings</span> <span class="kw">=</span> <span class="no">settings</span>,
  <span class="kw">value_col</span> <span class="kw">=</span> <span class="st">"value"</span>,
  <span class="kw">method_name</span> <span class="kw">=</span> <span class="st">"Prior"</span>
)

<span class="no">summary_prior</span> <span class="kw">&lt;-</span> <span class="kw pkg">popMethods</span><span class="kw ns">::</span><span class="fu"><a href="../reference/popReconstruct_fit.html">popReconstruct_summarize_draws</a></span>(
  <span class="kw">draws</span> <span class="kw">=</span> <span class="no">draws_prior</span>,
  <span class="kw">summarize_cols</span> <span class="kw">=</span> <span class="st">"draw"</span>
)</pre></body></html></div>
<p>Both <code>draws_prior</code> and <code>summary_prior</code> return a list of data.tables for different components of the model. There are data.tables for each of the ccmpp inputs (baseline, srb, asfr, survival, net_migration), the projected population, and the variance parameters for each ccmmp input and population. Additionally there are data.tables for the <code>offset_</code> parameters for each ccmpp input which is what is actually estimated in the popReconstruct model. When fitting the original model the <code>spline_offset_</code> parameters are exactly equal to the <code>offset_</code> parameters and we are going to ignore them for now, these are explained in the <code>vignette("popReconstruct_linear_splines", package = "popMethods)</code>.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">summary_prior</span>)
<span class="co">#&gt;                             Length Class      Mode</span>
<span class="co">#&gt; variance                    5      data.table list</span>
<span class="co">#&gt; population                  8      data.table list</span>
<span class="co">#&gt; offset_srb                  6      data.table list</span>
<span class="co">#&gt; offset_asfr                 8      data.table list</span>
<span class="co">#&gt; offset_baseline             8      data.table list</span>
<span class="co">#&gt; offset_survival             9      data.table list</span>
<span class="co">#&gt; offset_net_migration        9      data.table list</span>
<span class="co">#&gt; spline_offset_srb           6      data.table list</span>
<span class="co">#&gt; spline_offset_asfr          8      data.table list</span>
<span class="co">#&gt; spline_offset_baseline      8      data.table list</span>
<span class="co">#&gt; spline_offset_survival      9      data.table list</span>
<span class="co">#&gt; spline_offset_net_migration 9      data.table list</span>
<span class="co">#&gt; srb                         6      data.table list</span>
<span class="co">#&gt; asfr                        8      data.table list</span>
<span class="co">#&gt; baseline                    8      data.table list</span>
<span class="co">#&gt; survival                    9      data.table list</span>
<span class="co">#&gt; net_migration               9      data.table list</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">summary_prior</span>$<span class="no">population</span>)
<span class="co">#&gt;    year    sex age_start age_end method     mean     q2.5    q97.5</span>
<span class="co">#&gt; 1: 1960 female         0       5  Prior 397002.7 289187.6 597694.2</span>
<span class="co">#&gt; 2: 1960 female         5      10  Prior 295751.7 207282.4 408782.3</span>
<span class="co">#&gt; 3: 1960 female        10      15  Prior 263385.9 181068.6 351833.1</span>
<span class="co">#&gt; 4: 1960 female        15      20  Prior 249847.0 183158.9 344482.4</span>
<span class="co">#&gt; 5: 1960 female        20      25  Prior 207609.3 139700.2 286674.9</span>
<span class="co">#&gt; 6: 1960 female        25      30  Prior 177078.1 124639.0 233196.8</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">draws_prior</span>$<span class="no">population</span>)
<span class="co">#&gt;    year    sex age_start age_end    value draw method</span>
<span class="co">#&gt; 1: 1960 female         0       5 404054.1    1  Prior</span>
<span class="co">#&gt; 2: 1960 female         0       5 431341.4    2  Prior</span>
<span class="co">#&gt; 3: 1960 female         0       5 389268.3    3  Prior</span>
<span class="co">#&gt; 4: 1960 female         0       5 219547.8    4  Prior</span>
<span class="co">#&gt; 5: 1960 female         0       5 329019.6    5  Prior</span>
<span class="co">#&gt; 6: 1960 female         0       5 493664.2    6  Prior</span></pre></body></html></div>
</div>
<div id="fit-the-popreconstruct-model-with-stan" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-the-popreconstruct-model-with-stan" class="anchor"></a>Fit the popReconstruct model with Stan</h2>
<p><a href="https://mc-stan.org/">Stan</a> is a C++ program that does Bayesian statistical inference. It requires a model written in the Stan language that calculates the log posterior likelihood. The program can be compiled and then run from R, Python, or some other languages. By default it uses the no-U-turn MCMC sampler which is a variant of Hamiltonian Monte Carlo and the Metropolis Hastings algorithm. One of the nice things about Stan is that there is a large community of users with a well documented code base, manual and lots of examples.</p>
<p>Below the model is fit in Stan using <code><a href="../reference/popReconstruct_fit.html">popMethods::popReconstruct_fit</a></code> with the same inputs, hyperparameters and settings as for sampling from the prior. The <code>chains</code>, <code>warmup</code>, <code>iter</code>, and <code>seed</code> arguments are specific to fitting the model in stan and if we were actually using the results we’d want to run for more iterations/warmup with more chains.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">fit_stan</span> <span class="kw">&lt;-</span> <span class="kw pkg">popMethods</span><span class="kw ns">::</span><span class="fu"><a href="../reference/popReconstruct_fit.html">popReconstruct_fit</a></span>(
  <span class="kw">inputs</span> <span class="kw">=</span> <span class="kw pkg">demCore</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/demCore/man/burkina_faso.html">burkina_faso_initial_estimates</a></span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="kw pkg">demCore</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/demCore/man/burkina_faso.html">burkina_faso_data</a></span>,
  <span class="kw">hyperparameters</span> <span class="kw">=</span> <span class="no">hyperparameters</span>,
  <span class="kw">settings</span> <span class="kw">=</span> <span class="no">settings</span>,
  <span class="kw">value_col</span> <span class="kw">=</span> <span class="st">"value"</span>,
  <span class="kw">software</span> <span class="kw">=</span> <span class="st">"stan"</span>,
  <span class="kw">chains</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">warmup</span> <span class="kw">=</span> <span class="fl">1000</span>, <span class="kw">iter</span> <span class="kw">=</span> <span class="fl">2000</span>, <span class="kw">seed</span> <span class="kw">=</span> <span class="fl">3</span>
)

<span class="no">draws_stan</span> <span class="kw">&lt;-</span> <span class="kw pkg">popMethods</span><span class="kw ns">::</span><span class="fu"><a href="../reference/popReconstruct_fit.html">popReconstruct_posterior_draws</a></span>(
  <span class="kw">fit</span> <span class="kw">=</span> <span class="no">fit_stan</span>,
  <span class="kw">inputs</span> <span class="kw">=</span> <span class="kw pkg">demCore</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/demCore/man/burkina_faso.html">burkina_faso_initial_estimates</a></span>,
  <span class="kw">settings</span> <span class="kw">=</span> <span class="no">settings</span>,
  <span class="kw">value_col</span> <span class="kw">=</span> <span class="st">"value"</span>,
  <span class="kw">software</span> <span class="kw">=</span> <span class="st">"stan"</span>,
  <span class="kw">method_name</span> <span class="kw">=</span> <span class="st">"Stan"</span>
)

<span class="no">summary_stan</span> <span class="kw">&lt;-</span> <span class="kw pkg">popMethods</span><span class="kw ns">::</span><span class="fu"><a href="../reference/popReconstruct_fit.html">popReconstruct_summarize_draws</a></span>(
  <span class="kw">draws</span> <span class="kw">=</span> <span class="no">draws_stan</span>
)</pre></body></html></div>
<p>The outputs <code>draws_stan</code> and <code>summary_stan</code> are formatted exactly the same as the corresponding prior distribution outputs.</p>
<p>One of the cool features of fitting the model in stan is that we can then use a bunch of the built in diagnostics and accessory packages. This is explained more at the end of this vignette.</p>
</div>
<div id="fit-the-popreconstruct-model-with-tmb" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-the-popreconstruct-model-with-tmb" class="anchor"></a>Fit the popReconstruct model with TMB</h2>
<p><a href="https://kaskr.github.io/adcomp/Introduction.html">TMB</a> is another statistical modeling software written in C++. Similar to Stan, the model is written in TMB/C++ to calculate the log posterior likelihood. The program is then compiled and given to R optimizers like <code><a href="https://rdrr.io/r/stats/nlminb.html">nlminb()</a></code>.</p>
<p>TMB can be really fast because it uses the laplace approximation to integrate random effects whereas as MCMC integrates all parameters. Sometimes the laplace approximation is not accurate and its application to this model needs to be tested more rigorously. Whereas Stan provides a way to specify bounds for transformed parameters (in the popReconstruct model we need to constrain projected populations to be greater than or equal to zero), TMB does not. The constraint can only be applied when producing draws from the posterior distribution.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">fit_tmb</span> <span class="kw">&lt;-</span> <span class="kw pkg">popMethods</span><span class="kw ns">::</span><span class="fu"><a href="../reference/popReconstruct_fit.html">popReconstruct_fit</a></span>(
  <span class="kw">inputs</span> <span class="kw">=</span> <span class="kw pkg">demCore</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/demCore/man/burkina_faso.html">burkina_faso_initial_estimates</a></span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="kw pkg">demCore</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/demCore/man/burkina_faso.html">burkina_faso_data</a></span>,
  <span class="kw">hyperparameters</span> <span class="kw">=</span> <span class="no">hyperparameters</span>,
  <span class="kw">settings</span> <span class="kw">=</span> <span class="no">settings</span>,
  <span class="kw">value_col</span> <span class="kw">=</span> <span class="st">"value"</span>,
  <span class="kw">software</span> <span class="kw">=</span> <span class="st">"tmb"</span>
)

<span class="no">draws_tmb</span> <span class="kw">&lt;-</span> <span class="kw pkg">popMethods</span><span class="kw ns">::</span><span class="fu"><a href="../reference/popReconstruct_fit.html">popReconstruct_posterior_draws</a></span>(
  <span class="kw">fit</span> <span class="kw">=</span> <span class="no">fit_tmb</span>,
  <span class="kw">inputs</span> <span class="kw">=</span> <span class="kw pkg">demCore</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/demCore/man/burkina_faso.html">burkina_faso_initial_estimates</a></span>,
  <span class="kw">settings</span> <span class="kw">=</span> <span class="no">settings</span>,
  <span class="kw">value_col</span> <span class="kw">=</span> <span class="st">"value"</span>,
  <span class="kw">software</span> <span class="kw">=</span> <span class="st">"tmb"</span>,
  <span class="kw">method_name</span> <span class="kw">=</span> <span class="st">"TMB"</span>
)

<span class="no">summary_tmb</span> <span class="kw">&lt;-</span> <span class="kw pkg">popMethods</span><span class="kw ns">::</span><span class="fu"><a href="../reference/popReconstruct_fit.html">popReconstruct_summarize_draws</a></span>(
  <span class="kw">draws</span> <span class="kw">=</span> <span class="no">draws_tmb</span>,
  <span class="kw">summarize_cols</span> <span class="kw">=</span> <span class="st">"draw"</span>
)</pre></body></html></div>
</div>
</div>
<div id="plotting-and-comparing-the-results" class="section level1">
<h1 class="hasAnchor">
<a href="#plotting-and-comparing-the-results" class="anchor"></a>Plotting and comparing the results</h1>
<p>Now we have three sets of draws and summary statistics of the prior/posterior distribution using different statistical modeling software. <code><a href="../reference/rbindlist_dts.html">popMethods::rbindlist_dts</a></code> is a useful function to combine the three lists of data.tables into just one list of data.tables which can then be used for comparison plots.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">summary_combined</span> <span class="kw">&lt;-</span> <span class="kw pkg">popMethods</span><span class="kw ns">::</span><span class="fu"><a href="../reference/rbindlist_dts.html">rbindlist_dts</a></span>(
  <span class="no">summary_prior</span>,
  <span class="no">summary_stan</span>,
  <span class="no">summary_tmb</span>
)</pre></body></html></div>
<p>Theoretically the Stan and TMB models should be exploring the same posterior distribution and give similar results especially as we take more and more samples from the posterior distribution. In this example vignette we are using a reduced number of iterations and samples to reduce the runtime.</p>
<p>The following series of diagnostic plots for each component of the model include a line for the mean and the shaded areas go from the 2.5 to 97.5 percentiles.</p>
<p><img src="popReconstruct_files/figure-html/population_time_series-1.png" width="768"></p>
<p><img src="popReconstruct_files/figure-html/asfr_time_series-1.png" width="768"></p>
<p><img src="popReconstruct_files/figure-html/baseline-1.png" width="768"></p>
<p><img src="popReconstruct_files/figure-html/survival_time_series-1.png" width="768"></p>
<p><img src="popReconstruct_files/figure-html/net_migration_time_series-1.png" width="768"></p>
<p><img src="popReconstruct_files/figure-html/variance-1.png" width="768"></p>
</div>
<div id="additional-stan-diagnostics" class="section level1">
<h1 class="hasAnchor">
<a href="#additional-stan-diagnostics" class="anchor"></a>Additional Stan Diagnostics</h1>
<p>By fitting the popReconstruct model with Stan we can take advantage of many of the diagnostics built into the <code>rstan</code> package and other related packages like <code>shinystan</code> and <code>bayesplot</code>.</p>
<p>When printing out the model fit object you can get information about Rhat and the effective sample size. Stan has a nice <a href="https://mc-stan.org/misc/warnings.html">page</a> explaining some common warnings and diagnostics that people can run into. “Rhat” for example tests whether the MCMC chains have mixed well by comparing the between and within chain estimates.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">fit_stan_summary</span> <span class="kw">&lt;-</span> <span class="kw pkg">rstan</span><span class="kw ns">::</span><span class="fu">summary</span>(
  <span class="no">fit_stan</span>,
  <span class="kw">pars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"sigma2_srb"</span>, <span class="st">"sigma2_asfr"</span>, <span class="st">"sigma2_population"</span>, <span class="st">"sigma2_survival"</span>,
           <span class="st">"sigma2_net_migration"</span>),
  <span class="kw">probs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>)
)
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">fit_stan_summary</span>$<span class="no">summary</span>)
<span class="co">#&gt;                                mean      se_mean           sd          10%</span>
<span class="co">#&gt; sigma2_asfr[1]          0.010627086 7.882400e-04 0.0082551219 0.0034707760</span>
<span class="co">#&gt; sigma2_population       0.001304787 1.687933e-05 0.0003789351 0.0008718597</span>
<span class="co">#&gt; sigma2_survival[1]      0.014162378 1.446516e-03 0.0094675891 0.0044005551</span>
<span class="co">#&gt; sigma2_net_migration[1] 0.006534777 1.101004e-04 0.0016139674 0.0046413236</span>
<span class="co">#&gt;                                 90%     n_eff      Rhat</span>
<span class="co">#&gt; sigma2_asfr[1]          0.021267537 109.68067 1.0021244</span>
<span class="co">#&gt; sigma2_population       0.001773543 503.98676 0.9992325</span>
<span class="co">#&gt; sigma2_survival[1]      0.025468484  42.83831 1.0319712</span>
<span class="co">#&gt; sigma2_net_migration[1] 0.008658062 214.88759 1.0091627</span></pre></body></html></div>
<p>The <a href="https://mc-stan.org/users/interfaces/shinystan">shinystan R package</a> is also useful for being able to quickly look at useful diagnostics for all parameters.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="kw pkg">shinystan</span><span class="kw ns">::</span><span class="fu">launch_shinystan</span>(<span class="no">fit_stan</span>)</pre></body></html></div>
<p>The <a href="https://mc-stan.org/bayesplot/index.html">bayesplot R package</a> provides many plotting functions that can be used on MCMC objects from different statistical modeling packages. They return ggplot objects which means they can easily be extended upon too.</p>
<p>The following pairs plot shows univariate histograms and bivariate scatter plots for the variance parameters in the popReconstruct model. This plot is useful for identifying possible collinearity between parameters or multiplicative non-identifiabilities as explained <a href="https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html">here</a></p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">posterior</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(<span class="no">fit_stan</span>)
<span class="no">np</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="kw pkg">bayesplot</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/bayesplot-extractors.html">nuts_params</a></span>(<span class="no">fit_stan</span>))
<span class="kw pkg">bayesplot</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html">mcmc_pairs</a></span>(
  <span class="no">posterior</span>,
  <span class="kw">np</span> <span class="kw">=</span> <span class="no">np</span>,
  <span class="kw">pars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"sigma2_asfr[1]"</span>, <span class="st">"sigma2_population"</span>,  <span class="st">"sigma2_survival[1]"</span>,
           <span class="st">"sigma2_net_migration[1]"</span>, <span class="st">"lp__"</span>)
)</pre></body></html></div>
<p><img src="popReconstruct_files/figure-html/pairs_plot-1.png" width="768"></p>
<p>Another useful diagnostic is a trace plot which shows each chain as it changes for each iteration. The variance parameters for population and net_migration are nice examples of good mixing where the different chains are exploring the same parameter space. The trace plots for the variance parameters for asfr and survival indicate poor mixing which may be due to the few number of iterations used when fitting the model for this vignette.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="kw pkg">bayesplot</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html">mcmc_trace</a></span>(
  <span class="no">posterior</span>,
  <span class="kw">regex_pars</span> <span class="kw">=</span> <span class="st">"sigma2"</span>,
  <span class="kw">np</span> <span class="kw">=</span> <span class="no">np</span>) +
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Post-warmup iteration"</span>)</pre></body></html></div>
<p><img src="popReconstruct_files/figure-html/trace-1.png" width="768"></p>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<p>Wheldon, Mark C., Adrian E. Raftery, Samuel J. Clark, and Patrick Gerland. 2013. “Reconstructing Past Populations With Uncertainty From Fragmentary Data.” Journal of the American Statistical Association 108 (501): 96–110. <a href="https://doi.org/10.1080/01621459.2012.737729">https://doi.org/10.1080/01621459.2012.737729</a>.</p>
<p><a href="https://cran.r-project.org/web/packages/popReconstruct/popReconstruct.pdf">popReconstruct R Package</a></p>
<p>Wheldon, Mark C., Adrian E. Raftery, Samuel J. Clark, and Patrick Gerland. 2015. “Bayesian Reconstruction of Two-Sex Populations by Age: Estimating Sex Ratios at Birth and Sex Ratios of Mortality.” Journal of the Royal Statistical Society. Series A: Statistics in Society 178 (4): 977–1007. <a href="https://doi.org/10.1111/rssa.12104">https://doi.org/10.1111/rssa.12104</a>.</p>
<p><a href="https://github.com/markalava/Bayesian-Reconstruction">markalava/Bayesian-Reconstruction github repo</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Charlton Callender, Katie Paulson, Spencer Pease, Haidong Wang, Institute for Health Metrics and Evaluation.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
